---
- name: Install EPEL
  yum: name=epel-release state=present

- name: Install Services
  yum: name={{ item }} state=present
  with_items:
    - unbound
    - nsd
    - dhcp
    - ntp
    - ntpdate

- name: Install iptables
  yum: name=iptables state=present

- name: Add iptables script
  copy: src=iptables dest=/etc/network/if-up.d/iptables owner=root group=root mode=0740

- name: Make iptables.d
  file: path=/etc/iptables.d state=directory owner=root group=root mode=0740

- name: Configure IPv4 firewall
  copy: src=cluster.rules dest=/etc/iptables.d/cluster.rules owner=root group=root mode=0640
  notify:
  - iptables

- name: Copy NSD Config
  copy: src=nsd.conf dest=/etc/nsd/nsd.conf owner=root group=root mode=0640 validate='nsd-checkconf %s'
  notify:
    - nsd

- name: Add Master Zones
  copy: src={{ item }} dest=/etc/nsd/{{ item }} owner=root group=root mode=0640
  with_items:
    - cluster.lug.utdallas.edu
    - 42.16.172.in-addr.arpa
  notify:
    - nsd

- name: Copy Unbound Config
  template: src=unbound.conf dest=/etc/unbound/unbound.conf owner=root group=unbound mode=0644 validate='unbound-checkconf /etc/unbound/unbound.conf'
  notify:
    -unbound

- name: Run NSD Trust Setup
  command: nsd-control-setup

- name: Run Unbound Trust Setup
  command: unbound-control-setup

- name: Enable NSD
  service: name=nsd enabled=yes

- name: Start NSD
  service: name=nsd state=started

- name: Enable Unbound
  service: name=unbound enabled=yes

- name: Start Unbound
  service: name=unbound state=started

- name: Copy DHCP Config
  template: src=dhcpd.conf dest=/etc/dhcpd.conf owner=root group=root mode=0644
  notify:
    - dhcp

- name: Enable DHCP
  service: name=dhcp enabled=yes

- name: Start DHCP
  service: name=dhcp state=started

- name: Enable NTP
  service: name=ntp enabled=yes

- name: Start NTP
  service: name=ntp state=started
